import{AnimationClip as e,Bone as t,Box3 as s,BufferAttribute as n,BufferGeometry as r,ClampToEdgeWrapping as i,Color as a,ColorManagement as o,DirectionalLight as l,DoubleSide as u,FileLoader as c,FrontSide as h,Group as d,ImageBitmapLoader as T,InstancedMesh as p,InterleavedBuffer as m,InterleavedBufferAttribute as f,Interpolant as E,InterpolateDiscrete as A,InterpolateLinear as g,Line as x,LineBasicMaterial as S,LineLoop as R,LineSegments as N,LinearFilter as $,LinearMipmapLinearFilter as L,LinearMipmapNearestFilter as I,LinearSRGBColorSpace as O,Loader as v,LoaderUtils as M,Material as w,MathUtils as y,Matrix4 as C,Mesh as b,MeshBasicMaterial as G,MeshPhysicalMaterial as F,MeshStandardMaterial as P,MirroredRepeatWrapping as H,NearestFilter as B,NearestMipmapLinearFilter as D,NearestMipmapNearestFilter as _,NumberKeyframeTrack as U,Object3D as k,OrthographicCamera as X,PerspectiveCamera as K,PointLight as j,Points as W,PointsMaterial as V,PropertyBinding as Y,Quaternion as z,QuaternionKeyframeTrack as q,RepeatWrapping as Q,Skeleton as Z,SkinnedMesh as J,Sphere as ee,SpotLight as et,Texture as es,TextureLoader as en,TriangleFanDrawMode as er,TriangleStripDrawMode as ei,Vector2 as ea,Vector3 as eo,VectorKeyframeTrack as el,SRGBColorSpace as eu,InstancedBufferAttribute as ec}from"three";import{toTrianglesDrawMode as eh}from"../utils/BufferGeometryUtils.js";class GLTFLoader extends v{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(e){return new GLTFMaterialsClearcoatExtension(e)}),this.register(function(e){return new GLTFMaterialsDispersionExtension(e)}),this.register(function(e){return new GLTFTextureBasisUExtension(e)}),this.register(function(e){return new GLTFTextureWebPExtension(e)}),this.register(function(e){return new GLTFTextureAVIFExtension(e)}),this.register(function(e){return new GLTFMaterialsSheenExtension(e)}),this.register(function(e){return new GLTFMaterialsTransmissionExtension(e)}),this.register(function(e){return new GLTFMaterialsVolumeExtension(e)}),this.register(function(e){return new GLTFMaterialsIorExtension(e)}),this.register(function(e){return new GLTFMaterialsEmissiveStrengthExtension(e)}),this.register(function(e){return new GLTFMaterialsSpecularExtension(e)}),this.register(function(e){return new GLTFMaterialsIridescenceExtension(e)}),this.register(function(e){return new GLTFMaterialsAnisotropyExtension(e)}),this.register(function(e){return new GLTFMaterialsBumpExtension(e)}),this.register(function(e){return new GLTFLightsExtension(e)}),this.register(function(e){return new GLTFMeshoptCompression(e)}),this.register(function(e){return new GLTFMeshGpuInstancing(e)})}load(e,t,s,n){let r=this,i;if(""!==this.resourcePath)i=this.resourcePath;else if(""!==this.path){let a=M.extractUrlBase(e);i=M.resolveURL(a,this.path)}else i=M.extractUrlBase(e);this.manager.itemStart(e);let o=function(t){n?n(t):console.error(t),r.manager.itemError(e),r.manager.itemEnd(e)},l=new c(this.manager);l.setPath(this.path),l.setResponseType("arraybuffer"),l.setRequestHeader(this.requestHeader),l.setWithCredentials(this.withCredentials),l.load(e,function(s){try{r.parse(s,i,function(s){t(s),r.manager.itemEnd(e)},o)}catch(n){o(n)}},s,o)}setDRACOLoader(e){return this.dracoLoader=e,this}setDDSLoader(){throw Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return -1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return -1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,s,n){let r,i={},a={},o=new TextDecoder;if("string"==typeof e)r=JSON.parse(e);else if(e instanceof ArrayBuffer){let l=o.decode(new Uint8Array(e,0,4));if(l===BINARY_EXTENSION_HEADER_MAGIC){try{i[EXTENSIONS.KHR_BINARY_GLTF]=new GLTFBinaryExtension(e)}catch(u){n&&n(u);return}r=JSON.parse(i[EXTENSIONS.KHR_BINARY_GLTF].content)}else r=JSON.parse(o.decode(e))}else r=e;if(void 0===r.asset||r.asset.version[0]<2){n&&n(Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));return}let c=new GLTFParser(r,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});c.fileLoader.setRequestHeader(this.requestHeader);for(let h=0;h<this.pluginCallbacks.length;h++){let d=this.pluginCallbacks[h](c);d.name||console.error("THREE.GLTFLoader: Invalid plugin found: missing name"),a[d.name]=d,i[d.name]=!0}if(r.extensionsUsed)for(let T=0;T<r.extensionsUsed.length;++T){let p=r.extensionsUsed[T],m=r.extensionsRequired||[];switch(p){case EXTENSIONS.KHR_MATERIALS_UNLIT:i[p]=new GLTFMaterialsUnlitExtension;break;case EXTENSIONS.KHR_DRACO_MESH_COMPRESSION:i[p]=new GLTFDracoMeshCompressionExtension(r,this.dracoLoader);break;case EXTENSIONS.KHR_TEXTURE_TRANSFORM:i[p]=new GLTFTextureTransformExtension;break;case EXTENSIONS.KHR_MESH_QUANTIZATION:i[p]=new GLTFMeshQuantizationExtension;break;default:m.indexOf(p)>=0&&void 0===a[p]&&console.warn('THREE.GLTFLoader: Unknown extension "'+p+'".')}}c.setExtensions(i),c.setPlugins(a),c.parse(s,n)}parseAsync(e,t){let s=this;return new Promise(function(n,r){s.parse(e,t,n,r)})}}function GLTFRegistry(){let e={};return{get:function(t){return e[t]},add:function(t,s){e[t]=s},remove:function(t){delete e[t]},removeAll:function(){e={}}}}let EXTENSIONS={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_DISPERSION:"KHR_materials_dispersion",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class GLTFLightsExtension{constructor(e){this.parser=e,this.name=EXTENSIONS.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){let e=this.parser,t=this.parser.json.nodes||[];for(let s=0,n=t.length;s<n;s++){let r=t[s];r.extensions&&r.extensions[this.name]&&void 0!==r.extensions[this.name].light&&e._addNodeRef(this.cache,r.extensions[this.name].light)}}_loadLight(e){let t=this.parser,s="light:"+e,n=t.cache.get(s);if(n)return n;let r=t.json,i=r.extensions&&r.extensions[this.name]||{},o=i.lights||[],u=o[e],c,h=new a(16777215);void 0!==u.color&&h.setRGB(u.color[0],u.color[1],u.color[2],O);let d=void 0!==u.range?u.range:0;switch(u.type){case"directional":(c=new l(h)).target.position.set(0,0,-1),c.add(c.target);break;case"point":(c=new j(h)).distance=d;break;case"spot":(c=new et(h)).distance=d,u.spot=u.spot||{},u.spot.innerConeAngle=void 0!==u.spot.innerConeAngle?u.spot.innerConeAngle:0,u.spot.outerConeAngle=void 0!==u.spot.outerConeAngle?u.spot.outerConeAngle:Math.PI/4,c.angle=u.spot.outerConeAngle,c.penumbra=1-u.spot.innerConeAngle/u.spot.outerConeAngle,c.target.position.set(0,0,-1),c.add(c.target);break;default:throw Error("THREE.GLTFLoader: Unexpected light type: "+u.type)}return c.position.set(0,0,0),c.decay=2,assignExtrasToUserData(c,u),void 0!==u.intensity&&(c.intensity=u.intensity),c.name=t.createUniqueName(u.name||"light_"+e),n=Promise.resolve(c),t.cache.add(s,n),n}getDependency(e,t){if("light"===e)return this._loadLight(t)}createNodeAttachment(e){let t=this,s=this.parser,n=s.json,r=n.nodes[e],i=r.extensions&&r.extensions[this.name]||{},a=i.light;return void 0===a?null:this._loadLight(a).then(function(e){return s._getNodeRef(t.cache,a,e)})}}class GLTFMaterialsUnlitExtension{constructor(){this.name=EXTENSIONS.KHR_MATERIALS_UNLIT}getMaterialType(){return G}extendParams(e,t,s){let n=[];e.color=new a(1,1,1),e.opacity=1;let r=t.pbrMetallicRoughness;if(r){if(Array.isArray(r.baseColorFactor)){let i=r.baseColorFactor;e.color.setRGB(i[0],i[1],i[2],O),e.opacity=i[3]}void 0!==r.baseColorTexture&&n.push(s.assignTexture(e,"map",r.baseColorTexture,eu))}return Promise.all(n)}}class GLTFMaterialsEmissiveStrengthExtension{constructor(e){this.parser=e,this.name=EXTENSIONS.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){let s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();let r=n.extensions[this.name].emissiveStrength;return void 0!==r&&(t.emissiveIntensity=r),Promise.resolve()}}class GLTFMaterialsClearcoatExtension{constructor(e){this.parser=e,this.name=EXTENSIONS.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){let t=this.parser,s=t.json.materials[e];return s.extensions&&s.extensions[this.name]?F:null}extendMaterialParams(e,t){let s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();let r=[],i=n.extensions[this.name];if(void 0!==i.clearcoatFactor&&(t.clearcoat=i.clearcoatFactor),void 0!==i.clearcoatTexture&&r.push(s.assignTexture(t,"clearcoatMap",i.clearcoatTexture)),void 0!==i.clearcoatRoughnessFactor&&(t.clearcoatRoughness=i.clearcoatRoughnessFactor),void 0!==i.clearcoatRoughnessTexture&&r.push(s.assignTexture(t,"clearcoatRoughnessMap",i.clearcoatRoughnessTexture)),void 0!==i.clearcoatNormalTexture&&(r.push(s.assignTexture(t,"clearcoatNormalMap",i.clearcoatNormalTexture)),void 0!==i.clearcoatNormalTexture.scale)){let a=i.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new ea(a,a)}return Promise.all(r)}}class GLTFMaterialsDispersionExtension{constructor(e){this.parser=e,this.name=EXTENSIONS.KHR_MATERIALS_DISPERSION}getMaterialType(e){let t=this.parser,s=t.json.materials[e];return s.extensions&&s.extensions[this.name]?F:null}extendMaterialParams(e,t){let s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();let r=n.extensions[this.name];return t.dispersion=void 0!==r.dispersion?r.dispersion:0,Promise.resolve()}}class GLTFMaterialsIridescenceExtension{constructor(e){this.parser=e,this.name=EXTENSIONS.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){let t=this.parser,s=t.json.materials[e];return s.extensions&&s.extensions[this.name]?F:null}extendMaterialParams(e,t){let s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();let r=[],i=n.extensions[this.name];return void 0!==i.iridescenceFactor&&(t.iridescence=i.iridescenceFactor),void 0!==i.iridescenceTexture&&r.push(s.assignTexture(t,"iridescenceMap",i.iridescenceTexture)),void 0!==i.iridescenceIor&&(t.iridescenceIOR=i.iridescenceIor),void 0===t.iridescenceThicknessRange&&(t.iridescenceThicknessRange=[100,400]),void 0!==i.iridescenceThicknessMinimum&&(t.iridescenceThicknessRange[0]=i.iridescenceThicknessMinimum),void 0!==i.iridescenceThicknessMaximum&&(t.iridescenceThicknessRange[1]=i.iridescenceThicknessMaximum),void 0!==i.iridescenceThicknessTexture&&r.push(s.assignTexture(t,"iridescenceThicknessMap",i.iridescenceThicknessTexture)),Promise.all(r)}}class GLTFMaterialsSheenExtension{constructor(e){this.parser=e,this.name=EXTENSIONS.KHR_MATERIALS_SHEEN}getMaterialType(e){let t=this.parser,s=t.json.materials[e];return s.extensions&&s.extensions[this.name]?F:null}extendMaterialParams(e,t){let s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();let r=[];t.sheenColor=new a(0,0,0),t.sheenRoughness=0,t.sheen=1;let i=n.extensions[this.name];if(void 0!==i.sheenColorFactor){let o=i.sheenColorFactor;t.sheenColor.setRGB(o[0],o[1],o[2],O)}return void 0!==i.sheenRoughnessFactor&&(t.sheenRoughness=i.sheenRoughnessFactor),void 0!==i.sheenColorTexture&&r.push(s.assignTexture(t,"sheenColorMap",i.sheenColorTexture,eu)),void 0!==i.sheenRoughnessTexture&&r.push(s.assignTexture(t,"sheenRoughnessMap",i.sheenRoughnessTexture)),Promise.all(r)}}class GLTFMaterialsTransmissionExtension{constructor(e){this.parser=e,this.name=EXTENSIONS.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){let t=this.parser,s=t.json.materials[e];return s.extensions&&s.extensions[this.name]?F:null}extendMaterialParams(e,t){let s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();let r=[],i=n.extensions[this.name];return void 0!==i.transmissionFactor&&(t.transmission=i.transmissionFactor),void 0!==i.transmissionTexture&&r.push(s.assignTexture(t,"transmissionMap",i.transmissionTexture)),Promise.all(r)}}class GLTFMaterialsVolumeExtension{constructor(e){this.parser=e,this.name=EXTENSIONS.KHR_MATERIALS_VOLUME}getMaterialType(e){let t=this.parser,s=t.json.materials[e];return s.extensions&&s.extensions[this.name]?F:null}extendMaterialParams(e,t){let s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();let r=[],i=n.extensions[this.name];t.thickness=void 0!==i.thicknessFactor?i.thicknessFactor:0,void 0!==i.thicknessTexture&&r.push(s.assignTexture(t,"thicknessMap",i.thicknessTexture)),t.attenuationDistance=i.attenuationDistance||1/0;let o=i.attenuationColor||[1,1,1];return t.attenuationColor=new a().setRGB(o[0],o[1],o[2],O),Promise.all(r)}}class GLTFMaterialsIorExtension{constructor(e){this.parser=e,this.name=EXTENSIONS.KHR_MATERIALS_IOR}getMaterialType(e){let t=this.parser,s=t.json.materials[e];return s.extensions&&s.extensions[this.name]?F:null}extendMaterialParams(e,t){let s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();let r=n.extensions[this.name];return t.ior=void 0!==r.ior?r.ior:1.5,Promise.resolve()}}class GLTFMaterialsSpecularExtension{constructor(e){this.parser=e,this.name=EXTENSIONS.KHR_MATERIALS_SPECULAR}getMaterialType(e){let t=this.parser,s=t.json.materials[e];return s.extensions&&s.extensions[this.name]?F:null}extendMaterialParams(e,t){let s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();let r=[],i=n.extensions[this.name];t.specularIntensity=void 0!==i.specularFactor?i.specularFactor:1,void 0!==i.specularTexture&&r.push(s.assignTexture(t,"specularIntensityMap",i.specularTexture));let o=i.specularColorFactor||[1,1,1];return t.specularColor=new a().setRGB(o[0],o[1],o[2],O),void 0!==i.specularColorTexture&&r.push(s.assignTexture(t,"specularColorMap",i.specularColorTexture,eu)),Promise.all(r)}}class GLTFMaterialsBumpExtension{constructor(e){this.parser=e,this.name=EXTENSIONS.EXT_MATERIALS_BUMP}getMaterialType(e){let t=this.parser,s=t.json.materials[e];return s.extensions&&s.extensions[this.name]?F:null}extendMaterialParams(e,t){let s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();let r=[],i=n.extensions[this.name];return t.bumpScale=void 0!==i.bumpFactor?i.bumpFactor:1,void 0!==i.bumpTexture&&r.push(s.assignTexture(t,"bumpMap",i.bumpTexture)),Promise.all(r)}}class GLTFMaterialsAnisotropyExtension{constructor(e){this.parser=e,this.name=EXTENSIONS.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){let t=this.parser,s=t.json.materials[e];return s.extensions&&s.extensions[this.name]?F:null}extendMaterialParams(e,t){let s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();let r=[],i=n.extensions[this.name];return void 0!==i.anisotropyStrength&&(t.anisotropy=i.anisotropyStrength),void 0!==i.anisotropyRotation&&(t.anisotropyRotation=i.anisotropyRotation),void 0!==i.anisotropyTexture&&r.push(s.assignTexture(t,"anisotropyMap",i.anisotropyTexture)),Promise.all(r)}}class GLTFTextureBasisUExtension{constructor(e){this.parser=e,this.name=EXTENSIONS.KHR_TEXTURE_BASISU}loadTexture(e){let t=this.parser,s=t.json,n=s.textures[e];if(!n.extensions||!n.extensions[this.name])return null;let r=n.extensions[this.name],i=t.options.ktx2Loader;if(!i){if(!(s.extensionsRequired&&s.extensionsRequired.indexOf(this.name)>=0))return null;throw Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures")}return t.loadTextureImage(e,r.source,i)}}class GLTFTextureWebPExtension{constructor(e){this.parser=e,this.name=EXTENSIONS.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(e){let t=this.name,s=this.parser,n=s.json,r=n.textures[e];if(!r.extensions||!r.extensions[t])return null;let i=r.extensions[t],a=n.images[i.source],o=s.textureLoader;if(a.uri){let l=s.options.manager.getHandler(a.uri);null!==l&&(o=l)}return this.detectSupport().then(function(r){if(r)return s.loadTextureImage(e,i.source,o);if(n.extensionsRequired&&n.extensionsRequired.indexOf(t)>=0)throw Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return s.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){let t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(1===t.height)}})),this.isSupported}}class GLTFTextureAVIFExtension{constructor(e){this.parser=e,this.name=EXTENSIONS.EXT_TEXTURE_AVIF,this.isSupported=null}loadTexture(e){let t=this.name,s=this.parser,n=s.json,r=n.textures[e];if(!r.extensions||!r.extensions[t])return null;let i=r.extensions[t],a=n.images[i.source],o=s.textureLoader;if(a.uri){let l=s.options.manager.getHandler(a.uri);null!==l&&(o=l)}return this.detectSupport().then(function(r){if(r)return s.loadTextureImage(e,i.source,o);if(n.extensionsRequired&&n.extensionsRequired.indexOf(t)>=0)throw Error("THREE.GLTFLoader: AVIF required by asset but unsupported.");return s.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){let t=new Image;t.src="data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABcAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI=",t.onload=t.onerror=function(){e(1===t.height)}})),this.isSupported}}class GLTFMeshoptCompression{constructor(e){this.name=EXTENSIONS.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){let t=this.parser.json,s=t.bufferViews[e];if(!s.extensions||!s.extensions[this.name])return null;{let n=s.extensions[this.name],r=this.parser.getDependency("buffer",n.buffer),i=this.parser.options.meshoptDecoder;if(!i||!i.supported){if(!(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0))return null;throw Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files")}return r.then(function(e){let t=n.byteOffset||0,s=n.byteLength||0,r=n.count,a=n.byteStride,o=new Uint8Array(e,t,s);return i.decodeGltfBufferAsync?i.decodeGltfBufferAsync(r,a,o,n.mode,n.filter).then(function(e){return e.buffer}):i.ready.then(function(){let e=new ArrayBuffer(r*a);return i.decodeGltfBuffer(new Uint8Array(e),r,a,o,n.mode,n.filter),e})})}}}class GLTFMeshGpuInstancing{constructor(e){this.name=EXTENSIONS.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){let t=this.parser.json,s=t.nodes[e];if(!s.extensions||!s.extensions[this.name]||void 0===s.mesh)return null;let n=t.meshes[s.mesh];for(let r of n.primitives)if(r.mode!==WEBGL_CONSTANTS.TRIANGLES&&r.mode!==WEBGL_CONSTANTS.TRIANGLE_STRIP&&r.mode!==WEBGL_CONSTANTS.TRIANGLE_FAN&&void 0!==r.mode)return null;let i=s.extensions[this.name],a=i.attributes,o=[],l={};for(let u in a)o.push(this.parser.getDependency("accessor",a[u]).then(e=>(l[u]=e,l[u])));return o.length<1?null:(o.push(this.parser.createNodeMesh(e)),Promise.all(o).then(e=>{let t=e.pop(),s=t.isGroup?t.children:[t],n=e[0].count,r=[];for(let i of s){let a=new C,o=new eo,u=new z,c=new eo(1,1,1),h=new p(i.geometry,i.material,n);for(let d=0;d<n;d++)l.TRANSLATION&&o.fromBufferAttribute(l.TRANSLATION,d),l.ROTATION&&u.fromBufferAttribute(l.ROTATION,d),l.SCALE&&c.fromBufferAttribute(l.SCALE,d),h.setMatrixAt(d,a.compose(o,u,c));for(let T in l)if("_COLOR_0"===T){let m=l[T];h.instanceColor=new ec(m.array,m.itemSize,m.normalized)}else"TRANSLATION"!==T&&"ROTATION"!==T&&"SCALE"!==T&&i.geometry.setAttribute(T,l[T]);k.prototype.copy.call(h,i),this.parser.assignFinalMaterial(h),r.push(h)}return t.isGroup?(t.clear(),t.add(...r),t):r[0]}))}}let BINARY_EXTENSION_HEADER_MAGIC="glTF",BINARY_EXTENSION_HEADER_LENGTH=12,BINARY_EXTENSION_CHUNK_TYPES={JSON:1313821514,BIN:5130562};class GLTFBinaryExtension{constructor(e){this.name=EXTENSIONS.KHR_BINARY_GLTF,this.content=null,this.body=null;let t=new DataView(e,0,12),s=new TextDecoder;if(this.header={magic:s.decode(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==BINARY_EXTENSION_HEADER_MAGIC)throw Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw Error("THREE.GLTFLoader: Legacy binary file detected.");let n=this.header.length-12,r=new DataView(e,12),i=0;for(;i<n;){let a=r.getUint32(i,!0);i+=4;let o=r.getUint32(i,!0);if(i+=4,o===BINARY_EXTENSION_CHUNK_TYPES.JSON){let l=new Uint8Array(e,12+i,a);this.content=s.decode(l)}else if(o===BINARY_EXTENSION_CHUNK_TYPES.BIN){let u=12+i;this.body=e.slice(u,u+a)}i+=a}if(null===this.content)throw Error("THREE.GLTFLoader: JSON content not found.")}}class GLTFDracoMeshCompressionExtension{constructor(e,t){if(!t)throw Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=EXTENSIONS.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){let s=this.json,n=this.dracoLoader,r=e.extensions[this.name].bufferView,i=e.extensions[this.name].attributes,a={},o={},l={};for(let u in i){let c=ATTRIBUTES[u]||u.toLowerCase();a[c]=i[u]}for(let h in e.attributes){let d=ATTRIBUTES[h]||h.toLowerCase();if(void 0!==i[h]){let T=s.accessors[e.attributes[h]],p=WEBGL_COMPONENT_TYPES[T.componentType];l[d]=p.name,o[d]=!0===T.normalized}}return t.getDependency("bufferView",r).then(function(e){return new Promise(function(t,s){n.decodeDracoFile(e,function(e){for(let s in e.attributes){let n=e.attributes[s],r=o[s];void 0!==r&&(n.normalized=r)}t(e)},a,l,O,s)})})}}class GLTFTextureTransformExtension{constructor(){this.name=EXTENSIONS.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return(void 0===t.texCoord||t.texCoord===e.channel)&&void 0===t.offset&&void 0===t.rotation&&void 0===t.scale||(e=e.clone(),void 0!==t.texCoord&&(e.channel=t.texCoord),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),e.needsUpdate=!0),e}}class GLTFMeshQuantizationExtension{constructor(){this.name=EXTENSIONS.KHR_MESH_QUANTIZATION}}class GLTFCubicSplineInterpolant extends E{constructor(e,t,s,n){super(e,t,s,n)}copySampleValue_(e){let t=this.resultBuffer,s=this.sampleValues,n=this.valueSize,r=e*n*3+n;for(let i=0;i!==n;i++)t[i]=s[r+i];return t}interpolate_(e,t,s,n){let r=this.resultBuffer,i=this.sampleValues,a=this.valueSize,o=2*a,l=3*a,u=n-t,c=(s-t)/u,h=c*c,d=h*c,T=e*l,p=T-l,m=-2*d+3*h,f=d-h,E=1-m,A=f-h+c;for(let g=0;g!==a;g++){let x=i[p+g+a],S=i[p+g+o]*u,R=i[T+g+a],N=i[T+g]*u;r[g]=E*x+A*S+m*R+f*N}return r}}let _q=new z;class GLTFCubicSplineQuaternionInterpolant extends GLTFCubicSplineInterpolant{interpolate_(e,t,s,n){let r=super.interpolate_(e,t,s,n);return _q.fromArray(r).normalize().toArray(r),r}}let WEBGL_CONSTANTS={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123},WEBGL_COMPONENT_TYPES={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},WEBGL_FILTERS={9728:B,9729:$,9984:_,9985:I,9986:D,9987:L},WEBGL_WRAPPINGS={33071:i,33648:H,10497:Q},WEBGL_TYPE_SIZES={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},ATTRIBUTES={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},PATH_PROPERTIES={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},INTERPOLATION={CUBICSPLINE:void 0,LINEAR:g,STEP:A},ALPHA_MODES={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};function createDefaultMaterial(e){return void 0===e.DefaultMaterial&&(e.DefaultMaterial=new P({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:h})),e.DefaultMaterial}function addUnknownExtensionsToUserData(e,t,s){for(let n in s.extensions)void 0===e[n]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[n]=s.extensions[n])}function assignExtrasToUserData(e,t){void 0!==t.extras&&("object"==typeof t.extras?Object.assign(e.userData,t.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+t.extras))}function addMorphTargets(e,t,s){let n=!1,r=!1,i=!1;for(let a=0,o=t.length;a<o;a++){let l=t[a];if(void 0!==l.POSITION&&(n=!0),void 0!==l.NORMAL&&(r=!0),void 0!==l.COLOR_0&&(i=!0),n&&r&&i)break}if(!n&&!r&&!i)return Promise.resolve(e);let u=[],c=[],h=[];for(let d=0,T=t.length;d<T;d++){let p=t[d];if(n){let m=void 0!==p.POSITION?s.getDependency("accessor",p.POSITION):e.attributes.position;u.push(m)}if(r){let f=void 0!==p.NORMAL?s.getDependency("accessor",p.NORMAL):e.attributes.normal;c.push(f)}if(i){let E=void 0!==p.COLOR_0?s.getDependency("accessor",p.COLOR_0):e.attributes.color;h.push(E)}}return Promise.all([Promise.all(u),Promise.all(c),Promise.all(h)]).then(function(t){let s=t[0],a=t[1],o=t[2];return n&&(e.morphAttributes.position=s),r&&(e.morphAttributes.normal=a),i&&(e.morphAttributes.color=o),e.morphTargetsRelative=!0,e})}function updateMorphTargets(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(let s=0,n=t.weights.length;s<n;s++)e.morphTargetInfluences[s]=t.weights[s];if(t.extras&&Array.isArray(t.extras.targetNames)){let r=t.extras.targetNames;if(e.morphTargetInfluences.length===r.length){e.morphTargetDictionary={};for(let i=0,a=r.length;i<a;i++)e.morphTargetDictionary[r[i]]=i}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function createPrimitiveKey(e){let t,s=e.extensions&&e.extensions[EXTENSIONS.KHR_DRACO_MESH_COMPRESSION];if(t=s?"draco:"+s.bufferView+":"+s.indices+":"+createAttributesKey(s.attributes):e.indices+":"+createAttributesKey(e.attributes)+":"+e.mode,void 0!==e.targets)for(let n=0,r=e.targets.length;n<r;n++)t+=":"+createAttributesKey(e.targets[n]);return t}function createAttributesKey(e){let t="",s=Object.keys(e).sort();for(let n=0,r=s.length;n<r;n++)t+=s[n]+":"+e[s[n]]+";";return t}function getNormalizedComponentScale(e){switch(e){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}function getImageURIMimeType(e){return e.search(/\.jpe?g($|\?)/i)>0||0===e.search(/^data\:image\/jpeg/)?"image/jpeg":e.search(/\.webp($|\?)/i)>0||0===e.search(/^data\:image\/webp/)?"image/webp":"image/png"}let _identityMatrix=new C;class GLTFParser{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new GLTFRegistry,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let s=!1,n=-1,r=!1,i=-1;if("undefined"!=typeof navigator){let a=navigator.userAgent;s=!0===/^((?!chrome|android).)*safari/i.test(a);let o=a.match(/Version\/(\d+)/);n=s&&o?parseInt(o[1],10):-1,i=(r=a.indexOf("Firefox")>-1)?a.match(/Firefox\/([0-9]+)\./)[1]:-1}"undefined"==typeof createImageBitmap||s&&n<17||r&&i<98?this.textureLoader=new en(this.options.manager):this.textureLoader=new T(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new c(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){let s=this,n=this.json,r=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll(function(e){return e._markDefs&&e._markDefs()}),Promise.all(this._invokeAll(function(e){return e.beforeRoot&&e.beforeRoot()})).then(function(){return Promise.all([s.getDependencies("scene"),s.getDependencies("animation"),s.getDependencies("camera"),])}).then(function(t){let i={scene:t[0][n.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:n.asset,parser:s,userData:{}};return addUnknownExtensionsToUserData(r,i,n),assignExtrasToUserData(i,n),Promise.all(s._invokeAll(function(e){return e.afterRoot&&e.afterRoot(i)})).then(function(){for(let t of i.scenes)t.updateMatrixWorld();e(i)})}).catch(t)}_markDefs(){let e=this.json.nodes||[],t=this.json.skins||[],s=this.json.meshes||[];for(let n=0,r=t.length;n<r;n++){let i=t[n].joints;for(let a=0,o=i.length;a<o;a++)e[i[a]].isBone=!0}for(let l=0,u=e.length;l<u;l++){let c=e[l];void 0!==c.mesh&&(this._addNodeRef(this.meshCache,c.mesh),void 0!==c.skin&&(s[c.mesh].isSkinnedMesh=!0)),void 0!==c.camera&&this._addNodeRef(this.cameraCache,c.camera)}}_addNodeRef(e,t){void 0!==t&&(void 0===e.refs[t]&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,s){if(e.refs[t]<=1)return s;let n=s.clone(),r=(e,t)=>{let s=this.associations.get(e);for(let[n,i]of(null!=s&&this.associations.set(t,s),e.children.entries()))r(i,t.children[n])};return r(s,n),n.name+="_instance_"+e.uses[t]++,n}_invokeOne(e){let t=Object.values(this.plugins);t.push(this);for(let s=0;s<t.length;s++){let n=e(t[s]);if(n)return n}return null}_invokeAll(e){let t=Object.values(this.plugins);t.unshift(this);let s=[];for(let n=0;n<t.length;n++){let r=e(t[n]);r&&s.push(r)}return s}getDependency(e,t){let s=e+":"+t,n=this.cache.get(s);if(!n){switch(e){case"scene":n=this.loadScene(t);break;case"node":n=this._invokeOne(function(e){return e.loadNode&&e.loadNode(t)});break;case"mesh":n=this._invokeOne(function(e){return e.loadMesh&&e.loadMesh(t)});break;case"accessor":n=this.loadAccessor(t);break;case"bufferView":n=this._invokeOne(function(e){return e.loadBufferView&&e.loadBufferView(t)});break;case"buffer":n=this.loadBuffer(t);break;case"material":n=this._invokeOne(function(e){return e.loadMaterial&&e.loadMaterial(t)});break;case"texture":n=this._invokeOne(function(e){return e.loadTexture&&e.loadTexture(t)});break;case"skin":n=this.loadSkin(t);break;case"animation":n=this._invokeOne(function(e){return e.loadAnimation&&e.loadAnimation(t)});break;case"camera":n=this.loadCamera(t);break;default:if(!(n=this._invokeOne(function(s){return s!=this&&s.getDependency&&s.getDependency(e,t)})))throw Error("Unknown type: "+e)}this.cache.add(s,n)}return n}getDependencies(e){let t=this.cache.get(e);if(!t){let s=this,n=this.json[e+("mesh"===e?"es":"s")]||[];t=Promise.all(n.map(function(t,n){return s.getDependency(e,n)})),this.cache.add(e,t)}return t}loadBuffer(e){let t=this.json.buffers[e],s=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[EXTENSIONS.KHR_BINARY_GLTF].body);let n=this.options;return new Promise(function(e,r){s.load(M.resolveURL(t.uri,n.path),e,void 0,function(){r(Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))})})}loadBufferView(e){let t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then(function(e){let s=t.byteLength||0,n=t.byteOffset||0;return e.slice(n,n+s)})}loadAccessor(e){let t=this,s=this.json,r=this.json.accessors[e];if(void 0===r.bufferView&&void 0===r.sparse){let i=WEBGL_TYPE_SIZES[r.type],a=WEBGL_COMPONENT_TYPES[r.componentType],o=!0===r.normalized,l=new a(r.count*i);return Promise.resolve(new n(l,i,o))}let u=[];return void 0!==r.bufferView?u.push(this.getDependency("bufferView",r.bufferView)):u.push(null),void 0!==r.sparse&&(u.push(this.getDependency("bufferView",r.sparse.indices.bufferView)),u.push(this.getDependency("bufferView",r.sparse.values.bufferView))),Promise.all(u).then(function(e){let i=e[0],a=WEBGL_TYPE_SIZES[r.type],o=WEBGL_COMPONENT_TYPES[r.componentType],l=o.BYTES_PER_ELEMENT,u=r.byteOffset||0,c=void 0!==r.bufferView?s.bufferViews[r.bufferView].byteStride:void 0,h=!0===r.normalized,d,T;if(c&&c!==l*a){let p=Math.floor(u/c),E="InterleavedBuffer:"+r.bufferView+":"+r.componentType+":"+p+":"+r.count,A=t.cache.get(E);A||(d=new o(i,p*c,r.count*c/l),A=new m(d,c/l),t.cache.add(E,A)),T=new f(A,a,u%c/l,h)}else d=null===i?new o(r.count*a):new o(i,u,r.count*a),T=new n(d,a,h);if(void 0!==r.sparse){let g=WEBGL_TYPE_SIZES.SCALAR,x=WEBGL_COMPONENT_TYPES[r.sparse.indices.componentType],S=r.sparse.indices.byteOffset||0,R=r.sparse.values.byteOffset||0,N=new x(e[1],S,r.sparse.count*g),$=new o(e[2],R,r.sparse.count*a);null!==i&&(T=new n(T.array.slice(),T.itemSize,T.normalized));for(let L=0,I=N.length;L<I;L++){let O=N[L];if(T.setX(O,$[L*a]),a>=2&&T.setY(O,$[L*a+1]),a>=3&&T.setZ(O,$[L*a+2]),a>=4&&T.setW(O,$[L*a+3]),a>=5)throw Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return T})}loadTexture(e){let t=this.json,s=this.options,n=t.textures[e],r=n.source,i=t.images[r],a=this.textureLoader;if(i.uri){let o=s.manager.getHandler(i.uri);null!==o&&(a=o)}return this.loadTextureImage(e,r,a)}loadTextureImage(e,t,s){let n=this,r=this.json,i=r.textures[e],a=r.images[t],o=(a.uri||a.bufferView)+":"+i.sampler;if(this.textureCache[o])return this.textureCache[o];let l=this.loadImageSource(t,s).then(function(t){t.flipY=!1,t.name=i.name||a.name||"",""===t.name&&"string"==typeof a.uri&&!1===a.uri.startsWith("data:image/")&&(t.name=a.uri);let s=r.samplers||{},o=s[i.sampler]||{};return t.magFilter=WEBGL_FILTERS[o.magFilter]||$,t.minFilter=WEBGL_FILTERS[o.minFilter]||L,t.wrapS=WEBGL_WRAPPINGS[o.wrapS]||Q,t.wrapT=WEBGL_WRAPPINGS[o.wrapT]||Q,n.associations.set(t,{textures:e}),t}).catch(function(){return null});return this.textureCache[o]=l,l}loadImageSource(e,t){let s=this.json,n=this.options;if(void 0!==this.sourceCache[e])return this.sourceCache[e].then(e=>e.clone());let r=s.images[e],i=self.URL||self.webkitURL,a=r.uri||"",o=!1;if(void 0!==r.bufferView)a=this.getDependency("bufferView",r.bufferView).then(function(e){o=!0;let t=new Blob([e],{type:r.mimeType});return a=i.createObjectURL(t)});else if(void 0===r.uri)throw Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");let l=Promise.resolve(a).then(function(e){return new Promise(function(s,r){let i=s;!0===t.isImageBitmapLoader&&(i=function(e){let t=new es(e);t.needsUpdate=!0,s(t)}),t.load(M.resolveURL(e,n.path),i,void 0,r)})}).then(function(e){return!0===o&&i.revokeObjectURL(a),assignExtrasToUserData(e,r),e.userData.mimeType=r.mimeType||getImageURIMimeType(r.uri),e}).catch(function(e){throw console.error("THREE.GLTFLoader: Couldn't load texture",a),e});return this.sourceCache[e]=l,l}assignTexture(e,t,s,n){let r=this;return this.getDependency("texture",s.index).then(function(i){if(!i)return null;if(void 0!==s.texCoord&&s.texCoord>0&&((i=i.clone()).channel=s.texCoord),r.extensions[EXTENSIONS.KHR_TEXTURE_TRANSFORM]){let a=void 0!==s.extensions?s.extensions[EXTENSIONS.KHR_TEXTURE_TRANSFORM]:void 0;if(a){let o=r.associations.get(i);i=r.extensions[EXTENSIONS.KHR_TEXTURE_TRANSFORM].extendTexture(i,a),r.associations.set(i,o)}}return void 0!==n&&(i.colorSpace=n),e[t]=i,i})}assignFinalMaterial(e){let t=e.geometry,s=e.material,n=void 0===t.attributes.tangent,r=void 0!==t.attributes.color,i=void 0===t.attributes.normal;if(e.isPoints){let a="PointsMaterial:"+s.uuid,o=this.cache.get(a);o||(o=new V,w.prototype.copy.call(o,s),o.color.copy(s.color),o.map=s.map,o.sizeAttenuation=!1,this.cache.add(a,o)),s=o}else if(e.isLine){let l="LineBasicMaterial:"+s.uuid,u=this.cache.get(l);u||(u=new S,w.prototype.copy.call(u,s),u.color.copy(s.color),u.map=s.map,this.cache.add(l,u)),s=u}if(n||r||i){let c="ClonedMaterial:"+s.uuid+":";n&&(c+="derivative-tangents:"),r&&(c+="vertex-colors:"),i&&(c+="flat-shading:");let h=this.cache.get(c);h||(h=s.clone(),r&&(h.vertexColors=!0),i&&(h.flatShading=!0),n&&(h.normalScale&&(h.normalScale.y*=-1),h.clearcoatNormalScale&&(h.clearcoatNormalScale.y*=-1)),this.cache.add(c,h),this.associations.set(h,this.associations.get(s))),s=h}e.material=s}getMaterialType(){return P}loadMaterial(e){let t=this,s=this.json,n=this.extensions,r=s.materials[e],i,o={},l=r.extensions||{},c=[];if(l[EXTENSIONS.KHR_MATERIALS_UNLIT]){let h=n[EXTENSIONS.KHR_MATERIALS_UNLIT];i=h.getMaterialType(),c.push(h.extendParams(o,r,t))}else{let d=r.pbrMetallicRoughness||{};if(o.color=new a(1,1,1),o.opacity=1,Array.isArray(d.baseColorFactor)){let T=d.baseColorFactor;o.color.setRGB(T[0],T[1],T[2],O),o.opacity=T[3]}void 0!==d.baseColorTexture&&c.push(t.assignTexture(o,"map",d.baseColorTexture,eu)),o.metalness=void 0!==d.metallicFactor?d.metallicFactor:1,o.roughness=void 0!==d.roughnessFactor?d.roughnessFactor:1,void 0!==d.metallicRoughnessTexture&&(c.push(t.assignTexture(o,"metalnessMap",d.metallicRoughnessTexture)),c.push(t.assignTexture(o,"roughnessMap",d.metallicRoughnessTexture))),i=this._invokeOne(function(t){return t.getMaterialType&&t.getMaterialType(e)}),c.push(Promise.all(this._invokeAll(function(t){return t.extendMaterialParams&&t.extendMaterialParams(e,o)})))}!0===r.doubleSided&&(o.side=u);let p=r.alphaMode||ALPHA_MODES.OPAQUE;if(p===ALPHA_MODES.BLEND?(o.transparent=!0,o.depthWrite=!1):(o.transparent=!1,p===ALPHA_MODES.MASK&&(o.alphaTest=void 0!==r.alphaCutoff?r.alphaCutoff:.5)),void 0!==r.normalTexture&&i!==G&&(c.push(t.assignTexture(o,"normalMap",r.normalTexture)),o.normalScale=new ea(1,1),void 0!==r.normalTexture.scale)){let m=r.normalTexture.scale;o.normalScale.set(m,m)}if(void 0!==r.occlusionTexture&&i!==G&&(c.push(t.assignTexture(o,"aoMap",r.occlusionTexture)),void 0!==r.occlusionTexture.strength&&(o.aoMapIntensity=r.occlusionTexture.strength)),void 0!==r.emissiveFactor&&i!==G){let f=r.emissiveFactor;o.emissive=new a().setRGB(f[0],f[1],f[2],O)}return void 0!==r.emissiveTexture&&i!==G&&c.push(t.assignTexture(o,"emissiveMap",r.emissiveTexture,eu)),Promise.all(c).then(function(){let s=new i(o);return r.name&&(s.name=r.name),assignExtrasToUserData(s,r),t.associations.set(s,{materials:e}),r.extensions&&addUnknownExtensionsToUserData(n,s,r),s})}createUniqueName(e){let t=Y.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){let t=this,s=this.extensions,n=this.primitiveCache;function i(e){return s[EXTENSIONS.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then(function(s){return addPrimitiveAttributes(s,e,t)})}let a=[];for(let o=0,l=e.length;o<l;o++){let u=e[o],c=createPrimitiveKey(u),h=n[c];if(h)a.push(h.promise);else{let d;d=u.extensions&&u.extensions[EXTENSIONS.KHR_DRACO_MESH_COMPRESSION]?i(u):addPrimitiveAttributes(new r,u,t),n[c]={primitive:u,promise:d},a.push(d)}}return Promise.all(a)}loadMesh(e){let t=this,s=this.json,n=this.extensions,r=s.meshes[e],i=r.primitives,a=[];for(let o=0,l=i.length;o<l;o++){let u=void 0===i[o].material?createDefaultMaterial(this.cache):this.getDependency("material",i[o].material);a.push(u)}return a.push(t.loadGeometries(i)),Promise.all(a).then(function(s){let a=s.slice(0,s.length-1),o=s[s.length-1],l=[];for(let u=0,c=o.length;u<c;u++){let h=o[u],T=i[u],p,m=a[u];if(T.mode===WEBGL_CONSTANTS.TRIANGLES||T.mode===WEBGL_CONSTANTS.TRIANGLE_STRIP||T.mode===WEBGL_CONSTANTS.TRIANGLE_FAN||void 0===T.mode)!0===(p=!0===r.isSkinnedMesh?new J(h,m):new b(h,m)).isSkinnedMesh&&p.normalizeSkinWeights(),T.mode===WEBGL_CONSTANTS.TRIANGLE_STRIP?p.geometry=eh(p.geometry,ei):T.mode===WEBGL_CONSTANTS.TRIANGLE_FAN&&(p.geometry=eh(p.geometry,er));else if(T.mode===WEBGL_CONSTANTS.LINES)p=new N(h,m);else if(T.mode===WEBGL_CONSTANTS.LINE_STRIP)p=new x(h,m);else if(T.mode===WEBGL_CONSTANTS.LINE_LOOP)p=new R(h,m);else if(T.mode===WEBGL_CONSTANTS.POINTS)p=new W(h,m);else throw Error("THREE.GLTFLoader: Primitive mode unsupported: "+T.mode);Object.keys(p.geometry.morphAttributes).length>0&&updateMorphTargets(p,r),p.name=t.createUniqueName(r.name||"mesh_"+e),assignExtrasToUserData(p,r),T.extensions&&addUnknownExtensionsToUserData(n,p,T),t.assignFinalMaterial(p),l.push(p)}for(let f=0,E=l.length;f<E;f++)t.associations.set(l[f],{meshes:e,primitives:f});if(1===l.length)return r.extensions&&addUnknownExtensionsToUserData(n,l[0],r),l[0];let A=new d;r.extensions&&addUnknownExtensionsToUserData(n,A,r),t.associations.set(A,{meshes:e});for(let g=0,S=l.length;g<S;g++)A.add(l[g]);return A})}loadCamera(e){let t,s=this.json.cameras[e],n=s[s.type];if(!n){console.warn("THREE.GLTFLoader: Missing camera parameters.");return}return"perspective"===s.type?t=new K(y.radToDeg(n.yfov),n.aspectRatio||1,n.znear||1,n.zfar||2e6):"orthographic"===s.type&&(t=new X(-n.xmag,n.xmag,n.ymag,-n.ymag,n.znear,n.zfar)),s.name&&(t.name=this.createUniqueName(s.name)),assignExtrasToUserData(t,s),Promise.resolve(t)}loadSkin(e){let t=this.json.skins[e],s=[];for(let n=0,r=t.joints.length;n<r;n++)s.push(this._loadNodeShallow(t.joints[n]));return void 0!==t.inverseBindMatrices?s.push(this.getDependency("accessor",t.inverseBindMatrices)):s.push(null),Promise.all(s).then(function(e){let s=e.pop(),n=e,r=[],i=[];for(let a=0,o=n.length;a<o;a++){let l=n[a];if(l){r.push(l);let u=new C;null!==s&&u.fromArray(s.array,16*a),i.push(u)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[a])}return new Z(r,i)})}loadAnimation(t){let s=this.json,n=this,r=s.animations[t],i=r.name?r.name:"animation_"+t,a=[],o=[],l=[],u=[],c=[];for(let h=0,d=r.channels.length;h<d;h++){let T=r.channels[h],p=r.samplers[T.sampler],m=T.target,f=m.node,E=void 0!==r.parameters?r.parameters[p.input]:p.input,A=void 0!==r.parameters?r.parameters[p.output]:p.output;void 0!==m.node&&(a.push(this.getDependency("node",f)),o.push(this.getDependency("accessor",E)),l.push(this.getDependency("accessor",A)),u.push(p),c.push(m))}return Promise.all([Promise.all(a),Promise.all(o),Promise.all(l),Promise.all(u),Promise.all(c)]).then(function(t){let s=t[0],r=t[1],a=t[2],o=t[3],l=t[4],u=[];for(let c=0,h=s.length;c<h;c++){let d=s[c],T=r[c],p=a[c],m=o[c],f=l[c];if(void 0===d)continue;d.updateMatrix&&d.updateMatrix();let E=n._createAnimationTracks(d,T,p,m,f);if(E)for(let A=0;A<E.length;A++)u.push(E[A])}return new e(i,void 0,u)})}createNodeMesh(e){let t=this.json,s=this,n=t.nodes[e];return void 0===n.mesh?null:s.getDependency("mesh",n.mesh).then(function(e){let t=s._getNodeRef(s.meshCache,n.mesh,e);return void 0!==n.weights&&t.traverse(function(e){if(e.isMesh)for(let t=0,s=n.weights.length;t<s;t++)e.morphTargetInfluences[t]=n.weights[t]}),t})}loadNode(e){let t=this.json,s=t.nodes[e],n=this._loadNodeShallow(e),r=[],i=s.children||[];for(let a=0,o=i.length;a<o;a++)r.push(this.getDependency("node",i[a]));let l=void 0===s.skin?Promise.resolve(null):this.getDependency("skin",s.skin);return Promise.all([n,Promise.all(r),l]).then(function(e){let t=e[0],s=e[1],n=e[2];null!==n&&t.traverse(function(e){e.isSkinnedMesh&&e.bind(n,_identityMatrix)});for(let r=0,i=s.length;r<i;r++)t.add(s[r]);return t})}_loadNodeShallow(e){let s=this.json,n=this.extensions,r=this;if(void 0!==this.nodeCache[e])return this.nodeCache[e];let i=s.nodes[e],a=i.name?r.createUniqueName(i.name):"",o=[],l=r._invokeOne(function(t){return t.createNodeMesh&&t.createNodeMesh(e)});return l&&o.push(l),void 0!==i.camera&&o.push(r.getDependency("camera",i.camera).then(function(e){return r._getNodeRef(r.cameraCache,i.camera,e)})),r._invokeAll(function(t){return t.createNodeAttachment&&t.createNodeAttachment(e)}).forEach(function(e){o.push(e)}),this.nodeCache[e]=Promise.all(o).then(function(s){let o;if((o=!0===i.isBone?new t:s.length>1?new d:1===s.length?s[0]:new k)!==s[0])for(let l=0,u=s.length;l<u;l++)o.add(s[l]);if(i.name&&(o.userData.name=i.name,o.name=a),assignExtrasToUserData(o,i),i.extensions&&addUnknownExtensionsToUserData(n,o,i),void 0!==i.matrix){let c=new C;c.fromArray(i.matrix),o.applyMatrix4(c)}else void 0!==i.translation&&o.position.fromArray(i.translation),void 0!==i.rotation&&o.quaternion.fromArray(i.rotation),void 0!==i.scale&&o.scale.fromArray(i.scale);return r.associations.has(o)||r.associations.set(o,{}),r.associations.get(o).nodes=e,o}),this.nodeCache[e]}loadScene(e){let t=this.extensions,s=this.json.scenes[e],n=this,r=new d;s.name&&(r.name=n.createUniqueName(s.name)),assignExtrasToUserData(r,s),s.extensions&&addUnknownExtensionsToUserData(t,r,s);let i=s.nodes||[],a=[];for(let o=0,l=i.length;o<l;o++)a.push(n.getDependency("node",i[o]));return Promise.all(a).then(function(e){for(let t=0,s=e.length;t<s;t++)r.add(e[t]);return n.associations=(e=>{let t=new Map;for(let[s,r]of n.associations)(s instanceof w||s instanceof es)&&t.set(s,r);return e.traverse(e=>{let s=n.associations.get(e);null!=s&&t.set(e,s)}),t})(r),r})}_createAnimationTracks(e,t,s,n,r){let i=[],a=e.name?e.name:e.uuid,o=[];PATH_PROPERTIES[r.path]===PATH_PROPERTIES.weights?e.traverse(function(e){e.morphTargetInfluences&&o.push(e.name?e.name:e.uuid)}):o.push(a);let l;switch(PATH_PROPERTIES[r.path]){case PATH_PROPERTIES.weights:l=U;break;case PATH_PROPERTIES.rotation:l=q;break;case PATH_PROPERTIES.position:case PATH_PROPERTIES.scale:l=el;break;default:l=1===s.itemSize?U:el}let u=void 0!==n.interpolation?INTERPOLATION[n.interpolation]:g,c=this._getArrayFromAccessor(s);for(let h=0,d=o.length;h<d;h++){let T=new l(o[h]+"."+PATH_PROPERTIES[r.path],t.array,c,u);"CUBICSPLINE"===n.interpolation&&this._createCubicSplineTrackInterpolant(T),i.push(T)}return i}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){let s=getNormalizedComponentScale(t.constructor),n=new Float32Array(t.length);for(let r=0,i=t.length;r<i;r++)n[r]=t[r]*s;t=n}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function e(t){return new(this instanceof q?GLTFCubicSplineQuaternionInterpolant:GLTFCubicSplineInterpolant)(this.times,this.values,this.getValueSize()/3,t)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function computeBounds(e,t,n){let r=t.attributes,i=new s;if(void 0===r.POSITION)return;{let a=n.json.accessors[r.POSITION],o=a.min,l=a.max;if(void 0!==o&&void 0!==l){if(i.set(new eo(o[0],o[1],o[2]),new eo(l[0],l[1],l[2])),a.normalized){let u=getNormalizedComponentScale(WEBGL_COMPONENT_TYPES[a.componentType]);i.min.multiplyScalar(u),i.max.multiplyScalar(u)}}else{console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");return}}let c=t.targets;if(void 0!==c){let h=new eo,d=new eo;for(let T=0,p=c.length;T<p;T++){let m=c[T];if(void 0!==m.POSITION){let f=n.json.accessors[m.POSITION],E=f.min,A=f.max;if(void 0!==E&&void 0!==A){if(d.setX(Math.max(Math.abs(E[0]),Math.abs(A[0]))),d.setY(Math.max(Math.abs(E[1]),Math.abs(A[1]))),d.setZ(Math.max(Math.abs(E[2]),Math.abs(A[2]))),f.normalized){let g=getNormalizedComponentScale(WEBGL_COMPONENT_TYPES[f.componentType]);d.multiplyScalar(g)}h.max(d)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}i.expandByVector(h)}e.boundingBox=i;let x=new ee;i.getCenter(x.center),x.radius=i.min.distanceTo(i.max)/2,e.boundingSphere=x}function addPrimitiveAttributes(e,t,s){let n=t.attributes,r=[];function i(t,n){return s.getDependency("accessor",t).then(function(t){e.setAttribute(n,t)})}for(let a in n){let l=ATTRIBUTES[a]||a.toLowerCase();l in e.attributes||r.push(i(n[a],l))}if(void 0!==t.indices&&!e.index){let u=s.getDependency("accessor",t.indices).then(function(t){e.setIndex(t)});r.push(u)}return o.workingColorSpace!==O&&"COLOR_0"in n&&console.warn(`THREE.GLTFLoader: Converting vertex colors from "srgb-linear" to "${o.workingColorSpace}" not supported.`),assignExtrasToUserData(e,t),computeBounds(e,t,s),Promise.all(r).then(function(){return void 0!==t.targets?addMorphTargets(e,t.targets,s):e})}export{GLTFLoader};